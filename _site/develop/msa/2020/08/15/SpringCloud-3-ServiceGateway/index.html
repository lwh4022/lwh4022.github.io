<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      Maymanko&#39;s blog
    </title>
    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">
    <link rel="stylesheet" href="/assets/css/materialize.min.css" media="screen,projection">
    <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/main.css">
    
      
        <link rel="stylesheet" href="/assets/css/post.css">
      
      
      
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml">
    <link rel="stylesheet" href="/assets/css/github-markdown.css">
    <link rel="stylesheet" href="/assets/css/custom.css">
    <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v3.8.6" />
<meta property="og:title" content="스프링 클라우드 / Service Routing" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="스프링 마이크로 서비스 코딩 공작소" />
<meta property="og:description" content="스프링 마이크로 서비스 코딩 공작소" />
<link rel="canonical" href="http://localhost:4000/develop/msa/2020/08/15/SpringCloud-3-ServiceGateway/" />
<meta property="og:url" content="http://localhost:4000/develop/msa/2020/08/15/SpringCloud-3-ServiceGateway/" />
<meta property="og:site_name" content="Maymanko’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-08-15T00:00:00+09:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","datePublished":"2020-08-15T00:00:00+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/develop/msa/2020/08/15/SpringCloud-3-ServiceGateway/"},"url":"http://localhost:4000/develop/msa/2020/08/15/SpringCloud-3-ServiceGateway/","description":"스프링 마이크로 서비스 코딩 공작소","headline":"스프링 클라우드 / Service Routing","dateModified":"2020-08-15T00:00:00+09:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <script type="text/javascript" src="/assets/js/materialize.min.js"></script>
    <script type="text/javascript" src="/assets/js/main.js"></script>
  </head>
  
  <body style="font-family: 'Noto Sans KR', sans-serif;">
    <header>
      <nav class="top-nav hide-on-large-only">
        <div class="nav-wrapper" style="background-color: #000000; background-image: url('/assets/images/black-felt.png')">
          <div class="container">
            <a class="page-title" href="/">Maymanko's blog</a>
          </div>
        </div>
      </nav>
      <div class="container">
        <a href="#" data-target="slide-out" class="button-collapse top-nav full hide-on-large-only">
          <i class="material-icons">menu</i>
        </a>
      </div>
      <ul id="slide-out" class="sidenav sidenav-fixed" style="background-color: #000000; background-image: url('/assets/images/black-felt.png');">
        <li>
          <h4 class="center-align" style="font-weight: bold;"><a class="white-text page-title" href="/">Maymanko's blog</a></h4>
          <img class="circle z-depth-2 responsive-img" style="display:block; margin-left:auto; margin-right:auto; margin-top:20px; margin-bottom:20px; height:100px;" src="/assets/images/logo.jpeg"/>
        </li>
        
        
          <li>
            <a class="waves-effect" href="/develop" style="color:white;font-size: 1.5em;">
              <i class="material-icons" style="color:white;margin-right:16px;">code</i>
              Develop
                
              
                
                  <span style="font-size: 1.05rem;">(26)</span>
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
            </a>
          </li>
          <ul>
            
              <li>
                <a class="waves-effect" href="/develop/ddd" style="color:white;margin-left:40px;height:30px;line-height: 30px;font-size:1.15em">
                  DDD
                  
                    
                  
                    
                  
                    
                      <span style="font-size: 1.05rem;">(4)</span>
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                </a>
              </li>
            
              <li>
                <a class="waves-effect" href="/develop/msa" style="color:white;margin-left:40px;height:30px;line-height: 30px;font-size:1.15em">
                  MSA
                  
                    
                  
                    
                      <span style="font-size: 1.05rem;">(7)</span>
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                </a>
              </li>
            
              <li>
                <a class="waves-effect" href="/develop/docker" style="color:white;margin-left:40px;height:30px;line-height: 30px;font-size:1.15em">
                  Docker
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                      <span style="font-size: 1.05rem;">(1)</span>
                    
                  
                    
                  
                    
                  
                </a>
              </li>
            
              <li>
                <a class="waves-effect" href="/develop/react" style="color:white;margin-left:40px;height:30px;line-height: 30px;font-size:1.15em">
                  React
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                      <span style="font-size: 1.05rem;">(2)</span>
                    
                  
                    
                  
                    
                  
                    
                  
                </a>
              </li>
            
              <li>
                <a class="waves-effect" href="/develop/typescript" style="color:white;margin-left:40px;height:30px;line-height: 30px;font-size:1.15em">
                  Typescript
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                      <span style="font-size: 1.05rem;">(3)</span>
                    
                  
                </a>
              </li>
            
              <li>
                <a class="waves-effect" href="/develop/electron" style="color:white;margin-left:40px;height:30px;line-height: 30px;font-size:1.15em">
                  Electron
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                      <span style="font-size: 1.05rem;">(1)</span>
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                </a>
              </li>
            
              <li>
                <a class="waves-effect" href="/develop/rabbitmq" style="color:white;margin-left:40px;height:30px;line-height: 30px;font-size:1.15em">
                  RabbitMQ
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                </a>
              </li>
            
              <li>
                <a class="waves-effect" href="/develop/etc" style="color:white;margin-left:40px;height:30px;line-height: 30px;font-size:1.15em">
                  Etc
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                  
                    
                      <span style="font-size: 1.05rem;">(5)</span>
                    
                  
                    
                  
                </a>
              </li>
            
          </ul>
        
          <li>
            <a class="waves-effect" href="/life" style="color:white;font-size: 1.5em;">
              <i class="material-icons" style="color:white;margin-right:16px;">edit</i>
              Life
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
            </a>
          </li>
          <ul>
            
          </ul>
        
          <li>
            <a class="waves-effect" href="/vietnam" style="color:white;font-size: 1.5em;">
              <i class="material-icons" style="color:white;margin-right:16px;">public</i>
              Vietnam
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
                
              
            </a>
          </li>
          <ul>
            
          </ul>
        
      </ul>
      
    </header>
    <main>


<div class="container">
  <div id="post-info">
  <h3>스프링 클라우드 / Service Routing</h3>
  
</div>
<div class="divider"></div>
<div class="row">
  <div class="col s12 markdown-body">
    <blockquote>
  <p>스프링 마이크로 서비스 코딩 공작소</p>
</blockquote>

<h1 id="목차">목차</h1>
<h3 id="1장-spring-cloud-config-server">1장 Spring Cloud Config Server</h3>
<h3 id="2장-service-discovery">2장 Service Discovery</h3>
<h3 id="3장-client-recovery-pattern">3장 Client Recovery Pattern</h3>
<h3 id="4장-service-routing">4장 Service Routing</h3>
<h3 id="5장-msa-security">5장 MSA Security</h3>
<h3 id="6장-spring-cloud-stream을-사용한-event-driven-architecture">6장 Spring Cloud Stream을 사용한 Event Driven Architecture</h3>
<h3 id="7장-spring-cloud-slueth와-zipkins를-이용한-분산추적">7장 Spring Cloud Slueth와 Zipkins를 이용한 분산추적</h3>
<h3 id="8장-publishing">8장 Publishing</h3>

<hr />

<h1 id="service-routing">Service Routing</h1>

<h2 id="간단요약">간단요약</h2>
<h4 id="1-msa는-service-gateway-구축을-단순화">1. MSA는 Service Gateway 구축을 단순화</h4>
<h4 id="2-zuul-service는-netflix-eureka서버와-통합하고-eureka에-등록된-서비스를-자동으로-주울-경로에-매핑">2. Zuul Service는 Netflix Eureka서버와 통합하고 Eureka에 등록된 서비스를 자동으로 주울 경로에 매핑</h4>
<h4 id="3-zuul은-관리하는-모든-경로-앞에-api와-같은-prefix를-서비스-경로에-쉽게-추가-가능">3. Zuul은 관리하는 모든 경로 앞에 /api와 같은 Prefix를 서비스 경로에 쉽게 추가 가능</h4>
<h4 id="4-zuul을-사용하면-수동으로-경로-매핑을-정의-가능-이러한-경로-매핑은-application-구성-파일에-정의">4. Zuul을 사용하면 수동으로 경로 매핑을 정의 가능, 이러한 경로 매핑은 Application 구성 파일에 정의</h4>
<h4 id="5-spring-cloud-config-server를-사용해-주울-서버를-재시작하지-않고-경로-매핑을-동적으로-다시-로드-가능">5. Spring Cloud Config Server를 사용해 주울 서버를 재시작하지 않고 경로 매핑을 동적으로 다시 로드 가능</h4>
<h4 id="6-zuul의-hystrix와-ribbon-timeout을-전체-및-개별-서비스-수준으로-사용자-정의할-수-있음">6. Zuul의 Hystrix와 Ribbon timeout을 전체 및 개별 서비스 수준으로 사용자 정의할 수 있음</h4>
<h4 id="7-zuul-filter로-사용자-정의-비즈니스-로직을-구현할-수-있다-zuul은-3개의-zuul-filter인-사전필터와-사후필터-경로-필터를-제공">7. Zuul Filter로 사용자 정의 비즈니스 로직을 구현할 수 있다. Zuul은 3개의 Zuul Filter인 사전필터와 사후필터, 경로 필터를 제공</h4>
<h4 id="8-zuul의-사전-필터는-상관관계-id를-생성해-주울로-연결되는-모든-서비스에-주입">8. Zuul의 사전 필터는 상관관계 ID를 생성해 주울로 연결되는 모든 서비스에 주입</h4>
<h4 id="9-zuul의-사후-필터는-service-client에-대한-모든-http-서비스-응답에-상관관계-id를-삽입">9. Zuul의 사후 필터는 Service Client에 대한 모든 Http 서비스 응답에 상관관계 ID를 삽입</h4>
<h4 id="10-사용자-정의된-주울의-경로-필터는-유레카-서비스-id에-기반을-둔-동적-라우팅을-수행해-동일-서비스의-다른-버전에-대해-ab-테스팅을-수행-가능">10. 사용자 정의된 주울의 경로 필터는 유레카 서비스 ID에 기반을 둔 동적 라우팅을 수행해 동일 서비스의 다른 버전에 대해 A/B 테스팅을 수행 가능</h4>

<p><br />
<br /></p>

<h2 id="service-gateway">Service Gateway</h2>
<h4 id="1-하나의-url-뒤에-모든-서비스를-배치하고-서비스-디스커버리를-이용해-모든-호출을-실제-서비스-인스턴스로-매핑">1. 하나의 URL 뒤에 모든 서비스를 배치하고 서비스 디스커버리를 이용해 모든 호출을 실제 서비스 인스턴스로 매핑</h4>
<h4 id="2-서비스-게이트웨이를-경유하는-모든-서비스-호출에-상관관계-id를-삽입">2. 서비스 게이트웨이를 경유하는 모든 서비스 호출에 상관관계 ID를 삽입</h4>
<h4 id="3-호출할-때-생성된-상관관계-id를-http-응답에-삽입하고-클라이언트에-회신">3. 호출할 때 생성된 상관관계 ID를 HTTP 응답에 삽입하고 클라이언트에 회신</h4>
<h4 id="4-대중이-사용-중인-것과-다른-조직-서비스-인스턴스-엔드포인트로-라우팅하는-동적-라우팅-메커니즘을-구축">4. 대중이 사용 중인 것과 다른 조직 서비스 인스턴스 엔드포인트로 라우팅하는 동적 라우팅 메커니즘을 구축</h4>

<p><br />
<br /></p>

<h2 id="service-gateway의-역할">Service Gateway의 역할</h2>
<h4 id="1-정적-라우팅--개발자는-하나의-서비스-엔드포인트게이트웨이만-알면-됨">1. 정적 라우팅 : 개발자는 하나의 서비스 엔드포인트(게이트웨이)만 알면 됨</h4>
<h4 id="2-동적-라우팅">2. 동적 라우팅</h4>
<h4 id="3-인증과-인가">3. 인증과 인가</h4>
<h4 id="4-측정-지표-수집과-로깅">4. 측정 지표 수집과 로깅</h4>

<h2 id="service-gateway-구축시-유의사항">Service Gateway 구축시 유의사항</h2>
<h4 id="1-로드-밸런서는-서비스-게이트웨이-인스턴스-앞에-두는-것이-적절한-설계">1. 로드 밸런서는 서비스 게이트웨이 인스턴스 앞에 두는 것이 적절한 설계</h4>
<h4 id="2-서비스-게이트웨이-정보를-메모리애-저장하지-말-것">2. 서비스 게이트웨이 정보를 메모리애 저장하지 말 것</h4>

<h2 id="enablezuulproxy-vs-enablezuulserver">@EnableZuulProxy vs. @EnableZuulServer</h2>
<h4 id="1-enablezuulserver">1. @EnableZuulServer</h4>
<ul>
  <li>Zuul Reverse Proxy 필터를 로드하지 않은 Zuul 서버 생성 가능</li>
  <li>Netflix 유레카를 사용하는 Zuul 서버 생성 가능</li>
  <li>자체 라우팅 서비스를 만들고 내장된 주울 기능도 사용하지 않을 수 있음(유레카외 사용시)</li>
</ul>

<h2 id="zuul-path-matching-mechanism">Zuul Path matching mechanism</h2>
<h4 id="1-서비스-디스커버리를-이용한-자동-경로-매핑">1. 서비스 디스커버리를 이용한 자동 경로 매핑</h4>
<h4 id="2-서비스-디스커버리를-이용한-수동-경로-매핑">2. 서비스 디스커버리를 이용한 수동 경로 매핑</h4>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">zuul</span><span class="pi">:</span>
  <span class="na">ignored-service</span><span class="pi">:</span> <span class="s1">'</span><span class="s">organizationservice'</span>
  <span class="na">routes</span><span class="pi">:</span>
    <span class="na">organizationservice</span><span class="pi">:</span> <span class="s">/organization/**</span>
</code></pre></div></div>
<ul>
  <li>자동 경로 매핑만 사용할 시 실행 중인 서비스 인스턴스 가 없으면 경로를 노출하지 않음</li>
  <li>수동 서비스 디스커버리 사용시 서비스 인스턴스가 없더라도 주울은 그 경로 그대로 표시, 호출 시 500 발생</li>
</ul>

<h4 id="3-정적-url을-이용한-수동-경로-매핑">3. 정적 URL을 이용한 수동 경로 매핑</h4>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">zuul</span><span class="pi">:</span>
  <span class="na">routes</span><span class="pi">:</span>
    <span class="na">licensestatic</span><span class="pi">:</span>
      <span class="na">path</span><span class="pi">:</span> <span class="s">/licensestatic/**</span>
      <span class="na">serviceId</span><span class="pi">:</span> <span class="s">licensestatic</span>
<span class="na">ribbon</span><span class="pi">:</span>
  <span class="na">eureka</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">false</span>
<span class="na">licensestaic</span><span class="pi">:</span>
  <span class="na">ribbon</span><span class="pi">:</span>
    <span class="na">listOfServers</span><span class="pi">:</span> <span class="s">http://licenseservice-static1:8081, http://licenseservice-static2:8082</span>
</code></pre></div></div>

<h4 id="4-jvm-기반이-아닌-인스턴스--스프링-사이트카로-주울-서버에-등록">4. JVM 기반이 아닌 인스턴스 : 스프링 사이트카로 주울 서버에 등록</h4>

<p><br />
<br /></p>

<h2 id="경로-구성을-동적으로-로딩">경로 구성을 동적으로 로딩</h2>
<h4 id="post-기반-엔드포인트-기반인-refresh를-노출해-경로-구성을-다시-적용-가능">POST 기반 엔드포인트 기반인 /refresh를 노출해 경로 구성을 다시 적용 가능</h4>

<p><br />
<br /></p>

<h2 id="주울과-서비스-타임아웃">주울과 서비스 타임아웃</h2>
<h4 id="기본적으로-zuul은-요청을-처리하는데-1초-이상-걸리는-모든-호출을-종료하고-500에러-반환">기본적으로 Zuul은 요청을 처리하는데 1초 이상 걸리는 모든 호출을 종료하고 500에러 반환</h4>
<h4 id="custom-timeout">Custom timeout</h4>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">zuul.prefix</span><span class="pi">:</span> <span class="s">/api</span>
<span class="s">zuul.routes.organizationservice</span><span class="pi">:</span> <span class="s">/organization/**</span>
<span class="s">zuul.routes.licensingservice</span><span class="pi">:</span> <span class="s">/licensing/**</span>
<span class="s">zuul.debug.request</span><span class="pi">:</span> <span class="no">true</span>
<span class="s">hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds</span><span class="pi">:</span> <span class="m">7000</span>
<span class="s">licensingservice.ribbon.ReadTimeout</span><span class="pi">:</span> <span class="m">7000</span>
<span class="c1"># 일부 서비스 만 변경시 *.default.*를 서비스 이름으로 대체</span>
<span class="c1"># hystrix.command.licensingservice.execution.isolation.thread.timeoutInMilliseconds: 3000</span>
</code></pre></div></div>
<h3 id="-5초-이상의-타임아웃-구성은-히스트릭스와-리본-모두-설정해야-한다">* <strong>5초 이상의 타임아웃 구성은 히스트릭스와 리본 모두 설정해야 한다</strong></h3>

<p><br />
<br /></p>

<h2 id="사전-필터">사전 필터</h2>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">app</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserContext</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">CORRELATION_ID</span> <span class="o">=</span> <span class="s">"tmx-correlation-id"</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">AUTH_TOKEN</span> <span class="o">=</span> <span class="s">"tmx-auth-token"</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">USER_ID</span> <span class="o">=</span> <span class="s">"tmx-user-id"</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ORG_ID</span> <span class="o">=</span> <span class="s">"tmx-org-id"</span><span class="o">;</span>
	
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">correlationID</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">();</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">authToken</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">();</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">userId</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">();</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">orgId</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">();</span>
	
	<span class="kd">public</span> <span class="nf">UserContext</span><span class="o">()</span> <span class="o">{}</span>
	
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">getCorrelationID</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">correlationID</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCorrelationID</span><span class="o">(</span><span class="nc">String</span> <span class="n">correlationID</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">correlationID</span> <span class="o">=</span> <span class="n">correlationID</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">getAuthToken</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">authToken</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAuthToken</span><span class="o">(</span><span class="nc">String</span> <span class="n">authToken</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">authToken</span> <span class="o">=</span> <span class="n">authToken</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">getUserId</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">userId</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUserId</span><span class="o">(</span><span class="nc">String</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">userId</span> <span class="o">=</span> <span class="n">userId</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">getOrgId</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">orgId</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setOrgId</span><span class="o">(</span><span class="nc">String</span> <span class="n">orgId</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">orgId</span> <span class="o">=</span> <span class="n">orgId</span><span class="o">;</span>
	<span class="o">}</span>	
<span class="o">}</span>
</code></pre></div></div>
<p><br /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">app</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.util.Assert</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserContextHolder</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">UserContext</span><span class="o">&gt;</span> <span class="n">userContext</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">UserContext</span><span class="o">&gt;();</span>
	
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">UserContext</span> <span class="nf">getContext</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">UserContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">userContext</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">context</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">context</span> <span class="o">=</span> <span class="n">createEmptyContext</span><span class="o">();</span>
			<span class="n">userContext</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">userContext</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
	<span class="o">}</span>
	
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">setContext</span><span class="o">(</span><span class="nc">UserContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="s">"Only non-null UserContext instances are permitted"</span><span class="o">);</span>
		<span class="n">userContext</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
	<span class="o">}</span>
	
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">UserContext</span> <span class="nf">createEmptyContext</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">UserContext</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p><br /></p>
<h4 id="상관관계--id의-전파를-보장하는-사용자-정의-resttemplate과-usercontextinterceptor">상관관계  ID의 전파를 보장하는 사용자 정의 RestTemplate과 UserContextInterceptor</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">app</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.http.HttpHeaders</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.client.ClientHttpRequestExecution</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.client.ClientHttpRequestInterceptor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.client.ClientHttpResponse</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserContextInterceptor</span>  <span class="kd">implements</span> <span class="nc">ClientHttpRequestInterceptor</span><span class="o">{</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nc">ClientHttpResponse</span> <span class="nf">intercept</span><span class="o">(</span><span class="nc">HttpRequest</span> <span class="n">request</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">body</span><span class="o">,</span> <span class="nc">ClientHttpRequestExecution</span> <span class="n">execution</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
		<span class="nc">HttpHeaders</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">();</span>
		<span class="n">headers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">UserContext</span><span class="o">.</span><span class="na">CORRELATION_ID</span><span class="o">,</span> <span class="nc">UserContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getCorrelationID</span><span class="o">());</span>
		<span class="n">headers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">UserContext</span><span class="o">.</span><span class="na">AUTH_TOKEN</span><span class="o">,</span> <span class="nc">UserContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getAuthToken</span><span class="o">());</span>
		<span class="k">return</span> <span class="n">execution</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">body</span><span class="o">);</span>
	<span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>
<p><br /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableZuulProxy</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MsaApplication</span> <span class="o">{</span>

	<span class="nd">@LoadBalanced</span>
	<span class="nd">@Bean</span>
	<span class="kd">public</span> <span class="nc">RestTemplate</span> <span class="nf">getRestTemplate</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">RestTemplate</span> <span class="n">template</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RestTemplate</span><span class="o">();</span>
		<span class="nc">List</span> <span class="n">interceptors</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="na">getInterceptors</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">interceptors</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">template</span><span class="o">.</span><span class="na">setInterceptors</span><span class="o">(</span><span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="k">new</span> <span class="nc">UserContextInterceptor</span><span class="o">()));</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="n">interceptors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">UserContextInterceptor</span><span class="o">());</span>
			<span class="n">template</span><span class="o">.</span><span class="na">setInterceptors</span><span class="o">(</span><span class="n">interceptors</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">template</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">MsaApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

  </div>
</div>
</div>
